<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 7.0.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"xudalin0609.github.io","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="独自发疯">
<meta property="og:type" content="website">
<meta property="og:title" content="Relax And Slower">
<meta property="og:url" content="http://xudalin0609.github.io/index.html">
<meta property="og:site_name" content="Relax And Slower">
<meta property="og:description" content="独自发疯">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="Xu">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://xudalin0609.github.io/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>Relax And Slower</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Relax And Slower</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://xudalin0609.github.io/2017/01/01/flask%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB(%E4%B8%80)/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Xu">
      <meta itemprop="description" content="独自发疯">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Relax And Slower">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2017/01/01/flask%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB(%E4%B8%80)/" class="post-title-link" itemprop="url">flask源码阅读(一)</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2017-01-01 00:00:00" itemprop="dateCreated datePublished" datetime="2017-01-01T00:00:00+08:00">2017-01-01</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-11-06 23:06:17" itemprop="dateModified" datetime="2023-11-06T23:06:17+08:00">2023-11-06</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Flask/" itemprop="url" rel="index"><span itemprop="name">Flask</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="flask是如何被调用的"><a href="#flask是如何被调用的" class="headerlink" title="flask是如何被调用的"></a>flask是如何被调用的</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">hello_world</span>():</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;Hello, World!&#x27;</span></span><br><span class="line">    </span><br><span class="line"><span class="keyword">if</span> __name__ == __main__:</span><br><span class="line">    app.run()</span><br></pre></td></tr></table></figure>
<p>这是官方给出的一个最小的flask应用，可以看出flask的基本功能。</p>
<ol>
<li>生成一个Flask实例,即<code>app=Flask(__name__</code>)</li>
<li>调用<code>app.run()</code>使flask运行起来</li>
</ol>
<p>当然我们选择性的忽视了<code>app.route(&#39;/&#39;)</code>，这部分内容留到之后继续分析,现在我们先看看<code>app.run()</code>这个函数做了些什么。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">run</span>(<span class="params">self, host=<span class="string">&#x27;localhost&#x27;</span>, port=<span class="number">5000</span>, **options</span>):</span><br><span class="line">    <span class="keyword">from</span> werkzeug <span class="keyword">import</span> run_simple</span><br><span class="line">    <span class="keyword">return</span> run_simple(host, port, self, **options)</span><br></pre></td></tr></table></figure>

<p>以上是0.1版本的flask中<code>app.run()</code>的代码（注释和参数处理等无用信息被我删除了）。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line">我们会发现，在run（）中没有调用Flask类中的其他方法，那么请求（request）发送过来之后，Flask是如何接受请求又如何返回相应的呢？</span><br><span class="line">剩下的都就是werkzeug的任务了。</span><br><span class="line"></span><br><span class="line">在继续讨论werkzeug之前，先补充一下python的WSGI的相关知识.</span><br><span class="line"></span><br><span class="line">&gt; WSGI区分为两个部分：一为“服务器”或“网关”，另一为“应用程序”或“应用框架”。在处理一个WSGI请求时，服务器会为应用程序提供环境信息及一个回调函数（Callback Function）。当应用程序完成处理请求后，透过前述的回调函数，将结果回传给服务器。</span><br><span class="line">所谓的 WSGI 中间件同时实现了API的两方，因此可以在WSGI服务器和WSGI应用之间起调解作用：从Web服务器的角度来说，中间件扮演应用程序，而从应用程序的角度来说，中间件扮演服务器。“中间件”组件可以执行以下功能：</span><br><span class="line">重写环境变量后，根据目标URL，将请求消息路由到不同的应用对象。</span><br><span class="line">允许在一个进程中同时运行多个应用程序或应用框架。</span><br><span class="line">负载均衡和远程处理，通过在网络上转发请求和响应消息。</span><br><span class="line">进行内容后处理，例如应用XSLT样式表。  --wiki百科</span><br><span class="line"></span><br><span class="line">我们可以简单的将WSGI应用理解为一个在socket和flask之间的东西，负责接受并处理socket传来的信息,然后通过回调传递过来的app塞给flask之类的应用。例如在werkzeug中有这样一段代码就是调用app的</span><br><span class="line">```python</span><br><span class="line">def execute(app):</span><br><span class="line">    application_iter = app(environ, start_response)</span><br><span class="line">    try:</span><br><span class="line">        for data in application_iter:</span><br><span class="line">            write(data)</span><br><span class="line">        if not headers_sent:</span><br><span class="line">            write(b&#x27;&#x27;)</span><br><span class="line">    finally:</span><br><span class="line">        if hasattr(application_iter, &#x27;close&#x27;):</span><br><span class="line">            application_iter.close()</span><br><span class="line">            application_iter = None</span><br></pre></td></tr></table></figure>
<p>接下来我们就可以顺藤摸瓜到app的__call__()方法了</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">__call__</span>(<span class="params">self, environ, start_response</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Shortcut for :attr:`wsgi_app`&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> self.wsgi_app(environ, start_response)</span><br></pre></td></tr></table></figure>
<p>发现__call__调用了wsgi_app()方法，并传递了environ和start_response参数</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">def wsgi_app(self, environ, start_response):</span><br><span class="line">    &quot;&quot;&quot;The actual WSGI application.  This is not implemented in</span><br><span class="line">    `__call__` so that middlewares can be applied:</span><br><span class="line"></span><br><span class="line">        app.wsgi_app = MyMiddleware(app.wsgi_app)</span><br><span class="line"></span><br><span class="line">    :param environ: a WSGI environment</span><br><span class="line">    :param start_response: a callable accepting a status code,</span><br><span class="line">                           a list of headers and an optional</span><br><span class="line">                           exception context to start the response</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    with self.request_context(environ):</span><br><span class="line">        rv = self.preprocess_request()</span><br><span class="line">        if rv is None:</span><br><span class="line">            rv = self.dispatch_request()</span><br><span class="line">        response = self.make_response(rv)</span><br><span class="line">        response = self.process_response(response)</span><br><span class="line">        return response(environ, start_response)</span><br></pre></td></tr></table></figure>
<p>wsgi_app也只做了一件简单的事情，找到处理函数并调用，生成响应(response),至于如何找到处理函数并生成response的，后续会逐步分析。</p>
<p>至此，我们就可以认为一个简单的flask服务就启动成功了。总结一下</p>
<ol>
<li>实例化一个Flask类并调用run方法，将app实例作为参数传递给WSGI服务，如werkzeug</li>
<li>WSGI服务接收到请求后调用app，并传入request的参数</li>
<li>app被调用后调用自身的wsgi_app()方法，找到对应的处理函数，生成response并返回</li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://xudalin0609.github.io/2017/01/01/flask%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB(%E4%B8%89)/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Xu">
      <meta itemprop="description" content="独自发疯">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Relax And Slower">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2017/01/01/flask%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB(%E4%B8%89)/" class="post-title-link" itemprop="url">flask源码阅读(三)</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2017-01-01 00:00:00" itemprop="dateCreated datePublished" datetime="2017-01-01T00:00:00+08:00">2017-01-01</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-11-06 23:07:46" itemprop="dateModified" datetime="2023-11-06T23:07:46+08:00">2023-11-06</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Flask/" itemprop="url" rel="index"><span itemprop="name">Flask</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="flask-是如何取出-request-的"><a href="#flask-是如何取出-request-的" class="headerlink" title="flask 是如何取出 request 的"></a>flask 是如何取出 request 的</h1><p>之前分析 wsgi_app()函数的时候看到，当 flask 接受到了请求后，会生成一个 Request 的对象，并调用了 push()方法，在后续的使用中，会直接取出 request 中的参数传入业务逻辑函数。那么 Request 对象内部做了些什么？又是什么样的数据结构呢？这里就开始分析一下 flask 内部的 RequestContext 类。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">wsgi_app</span>(<span class="params">self, environ, start_response</span>):</span><br><span class="line">    ctx = self.request_context(environ)</span><br><span class="line">    ctx.push()</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">request_context</span>(<span class="params">self, environ</span>):</span><br><span class="line">    <span class="keyword">return</span> RequestContext(self, environ)</span><br></pre></td></tr></table></figure>

<p>可以看到 wsgi_app()调用了 request_context()方法，request_context()返回了 RequestContext 的实例。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">RequestContext</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, app, environ, request=<span class="literal">None</span></span>):</span><br><span class="line">        self.app = app</span><br><span class="line">        <span class="keyword">if</span> request <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            request = app.request_class(environ)</span><br><span class="line">        self.request = request</span><br><span class="line">        self.url_adapter = app.create_url_adapter(self.request)</span><br><span class="line">        self.flashes = <span class="literal">None</span></span><br><span class="line">        self.session = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">        self._implicit_app_ctx_stack = []</span><br><span class="line"></span><br><span class="line">        self.preserved = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">        self._preserved_exc = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">        self._after_request_functions = []</span><br><span class="line"></span><br><span class="line">        self.match_request()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">push</span>(<span class="params">self</span>):</span><br><span class="line"></span><br><span class="line">        top = _request_ctx_stack.top</span><br><span class="line">        <span class="keyword">if</span> top <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span> <span class="keyword">and</span> top.preserved:</span><br><span class="line">            top.pop(top._preserved_exc)</span><br><span class="line"></span><br><span class="line">        app_ctx = _app_ctx_stack.top</span><br><span class="line">        <span class="keyword">if</span> app_ctx <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">or</span> app_ctx.app != self.app:</span><br><span class="line">            app_ctx = self.app.app_context()</span><br><span class="line">            app_ctx.push()</span><br><span class="line">            self._implicit_app_ctx_stack.append(app_ctx)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            self._implicit_app_ctx_stack.append(<span class="literal">None</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">hasattr</span>(sys, <span class="string">&#x27;exc_clear&#x27;</span>):</span><br><span class="line">            sys.exc_clear()</span><br><span class="line"></span><br><span class="line">        _request_ctx_stack.push(self)</span><br><span class="line"></span><br><span class="line">        self.session = self.app.open_session(self.request)</span><br><span class="line">        <span class="keyword">if</span> self.session <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            self.session = self.app.make_null_session()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在初始化 RequestContext 实例的时候，传入了 Flask()实例和 environ 变量，并使用 environ 生成了 Requst 实例，这里不继续深究 Requst 实例的细节。</p>
<p>继续分析 push()函数做了什么。这里使用到了_request_ctx_stack 和_app_ctx_stack 的全局变量。分别对_request_ctx_stack 和_app_ctx_stack 取出了栈顶的值，并且将 ReqeustContext 的实例压入_request_ctx_stack 中。那么_reqeust_ctx_stack 和_app_ctx_stack 是什么呢？又为什么要使用这两个栈呢？继续看看这两个栈的代码细节。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># context locals</span></span><br><span class="line">_request_ctx_stack = LocalStack()</span><br><span class="line">_app_ctx_stack = LocalStack()</span><br><span class="line">current_app = LocalProxy(_find_app)</span><br><span class="line">request = LocalProxy(partial(_lookup_req_object, <span class="string">&#x27;request&#x27;</span>))</span><br><span class="line">session = LocalProxy(partial(_lookup_req_object, <span class="string">&#x27;session&#x27;</span>))</span><br><span class="line">g = LocalProxy(partial(_lookup_app_object, <span class="string">&#x27;g&#x27;</span>))</span><br></pre></td></tr></table></figure>

<p>可以看到二者都是 LocalStack()的实例，至此我们可以知道，我们处理 environ 参数的流程如下</p>
<ol>
<li>获取到 environ</li>
<li>生成 RequestContext 对象</li>
<li>将 RequestContext 压入_request_ctx_stack</li>
</ol>
<p>回忆我们前文找到业务逻辑并传入参数的代码</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">dispatch_request</span>(<span class="params">self</span>):</span><br><span class="line">    req = _request_ctx_stack.top.request</span><br><span class="line">    <span class="keyword">if</span> req.routing_exception <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">        self.raise_routing_exception(req)</span><br><span class="line">    rule = req.url_rule</span><br><span class="line">    <span class="comment"># if we provide automatic options for this URL and the</span></span><br><span class="line">    <span class="comment"># request came with the OPTIONS method, reply automatically</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">getattr</span>(rule, <span class="string">&#x27;provide_automatic_options&#x27;</span>, <span class="literal">False</span>) \</span><br><span class="line">       <span class="keyword">and</span> req.method == <span class="string">&#x27;OPTIONS&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> self.make_default_options_response()</span><br><span class="line">    <span class="comment"># otherwise dispatch to the handler for that endpoint</span></span><br><span class="line">    <span class="keyword">return</span> self.view_functions[rule.endpoint](**req.view_args)</span><br></pre></td></tr></table></figure>

<p>也就是说从当前的栈顶直接取出就是 reqeust 的参数，那么问题来了，如果是多线程的情况，如何能保证取到当前线程的参数呢？继续深入 LocalStack 的代码实现。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">LocalStack</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        self._local = Local()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__release_local__</span>(<span class="params">self</span>):</span><br><span class="line">        self._local.__release_local__()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__call__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">_lookup</span>():</span><br><span class="line">            rv = self.top</span><br><span class="line">            <span class="keyword">if</span> rv <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">                <span class="keyword">raise</span> RuntimeError(<span class="string">&#x27;object unbound&#x27;</span>)</span><br><span class="line">            <span class="keyword">return</span> rv</span><br><span class="line">        <span class="keyword">return</span> LocalProxy(_lookup)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">push</span>(<span class="params">self, obj</span>):</span><br><span class="line">        rv = <span class="built_in">getattr</span>(self._local, <span class="string">&#x27;stack&#x27;</span>, <span class="literal">None</span>)</span><br><span class="line">        <span class="keyword">if</span> rv <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            self._local.stack = rv = []</span><br><span class="line">        rv.append(obj)</span><br><span class="line">        <span class="keyword">return</span> rv</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">pop</span>(<span class="params">self</span>):</span><br><span class="line">        stack = <span class="built_in">getattr</span>(self._local, <span class="string">&#x27;stack&#x27;</span>, <span class="literal">None</span>)</span><br><span class="line">        <span class="keyword">if</span> stack <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">        <span class="keyword">elif</span> <span class="built_in">len</span>(stack) == <span class="number">1</span>:</span><br><span class="line">            release_local(self._local)</span><br><span class="line">            <span class="keyword">return</span> stack[-<span class="number">1</span>]</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> stack.pop()</span><br><span class="line"></span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">top</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">return</span> self._local.stack[-<span class="number">1</span>]</span><br><span class="line">        <span class="keyword">except</span> (AttributeError, IndexError):</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br></pre></td></tr></table></figure>

<p>LocalStack 并没有解决我们的问题。但是我们可以知道，其实 LocalStack 内部实现了 Local 的实例_local，并将传入的值以”stack”的 key 传入_local。那么 Local 又实现了什么？</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    <span class="keyword">from</span> greenlet <span class="keyword">import</span> getcurrent <span class="keyword">as</span> get_ident</span><br><span class="line"><span class="keyword">except</span> ImportError:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">from</span> thread <span class="keyword">import</span> get_ident</span><br><span class="line">    <span class="keyword">except</span> ImportError:</span><br><span class="line">        <span class="keyword">from</span> _thread <span class="keyword">import</span> get_ident</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Local</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    __slots__ = (<span class="string">&#x27;__storage__&#x27;</span>, <span class="string">&#x27;__ident_func__&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">object</span>.__setattr__(self, <span class="string">&#x27;__storage__&#x27;</span>, &#123;&#125;)</span><br><span class="line">        <span class="built_in">object</span>.__setattr__(self, <span class="string">&#x27;__ident_func__&#x27;</span>, get_ident)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__call__</span>(<span class="params">self, proxy</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Create a proxy for a name.&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> LocalProxy(self, proxy)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__release_local__</span>(<span class="params">self</span>):</span><br><span class="line">        self.__storage__.pop(self.__ident_func__(), <span class="literal">None</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">return</span> self.__storage__[self.__ident_func__()][name]</span><br><span class="line">        <span class="keyword">except</span> KeyError:</span><br><span class="line">            <span class="keyword">raise</span> AttributeError(name)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__setattr__</span>(<span class="params">self, name, value</span>):</span><br><span class="line">        ident = self.__ident_func__()</span><br><span class="line">        storage = self.__storage__</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            storage[ident][name] = value</span><br><span class="line">        <span class="keyword">except</span> KeyError:</span><br><span class="line">            storage[ident] = &#123;name: value&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__delattr__</span>(<span class="params">self, name</span>):</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">del</span> self.__storage__[self.__ident_func__()][name]</span><br><span class="line">        <span class="keyword">except</span> KeyError:</span><br><span class="line">            <span class="keyword">raise</span> AttributeError(name)</span><br></pre></td></tr></table></figure>

<p>从以上可以发现重写了<strong>setattr</strong>, <strong>delattr</strong>, <strong>release_local</strong>方法 Local 将相关的属性存入了<strong>storage</strong>,而<strong>setattr</strong>在存储 key,value 的时候，使用的其实是一个二层字典，结构为<strong>storage</strong>[ident][name],其中 ident 为 get_ident()方法的返回值，也就是当前线程的值。这也就解释了 Local 是如何实现线程隔离的存储 request 参数的了。</p>
<p>在 Local 的<strong>call</strong>中，创建了一个 LocalProxy 对象，那么这又是什么？</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">LocalProxy</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Acts as a proxy for a werkzeug local.</span></span><br><span class="line"><span class="string">    Forwards all operations to a proxied object. &quot;&quot;&quot;</span></span><br><span class="line">    __slots__ = (<span class="string">&#x27;__local&#x27;</span>, <span class="string">&#x27;__dict__&#x27;</span>, <span class="string">&#x27;__name__&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, local, name=<span class="literal">None</span></span>):</span><br><span class="line">        <span class="built_in">object</span>.__setattr__(self, <span class="string">&#x27;_LocalProxy__local&#x27;</span>, local)</span><br><span class="line">        <span class="built_in">object</span>.__setattr__(self, <span class="string">&#x27;__name__&#x27;</span>, name)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_get_current_object</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Return the current object.&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">hasattr</span>(self.__local, <span class="string">&#x27;__release_local__&#x27;</span>):</span><br><span class="line">            <span class="keyword">return</span> self.__local()</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">getattr</span>(self.__local, self.__name__)</span><br><span class="line">        <span class="keyword">except</span> AttributeError:</span><br><span class="line">            <span class="keyword">raise</span> RuntimeError(<span class="string">&#x27;no object bound to %s&#x27;</span> % self.__name__)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__dict__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">return</span> self._get_current_object().__dict__</span><br><span class="line">        <span class="keyword">except</span> RuntimeError:</span><br><span class="line">            <span class="keyword">raise</span> AttributeError(<span class="string">&#x27;__dict__&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__getattr__</span>(<span class="params">self, name</span>):</span><br><span class="line">        <span class="keyword">if</span> name == <span class="string">&#x27;__members__&#x27;</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">dir</span>(self._get_current_object())</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">getattr</span>(self._get_current_object(), name)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__setitem__</span>(<span class="params">self, key, value</span>):</span><br><span class="line">        self._get_current_object()[key] = value</span><br></pre></td></tr></table></figure>

<p>我们看到在 LocalProxy 类出初始化的时候，传入了一个 local 对象。并将该对象保存在<strong>local 中。**注意，</strong>setattr<strong>方法中使用的是_LocalProxy</strong>local,这是因为在 python 中<strong>开头的属性会被保存为_ClassName</strong>variable 的形式**。然后使用的是_get_current_object()方法从__local 中获取对应的对象。</p>
<p>这里实现的关键是把通过参数传递进来的 Local 实例保存在 __local 属性中，并定义了 _get_current_object() 方法获取当前线程或者协程对应的对象。</p>
<p>LocalProxy 是一个典型的代理模式实现，它在构造时接受一个 callable 的参数（比如一个函数），这个参数被调用后的返回值本身应该是一个 Thread Local 对象。对一个 LocalProxy 对象的所有操作，包括属性访问、方法调用（当然方法调用就是属性访问）甚至是二元操作都会转发到那个 callable 参数返回的 Thread Local 对象上。</p>
<p>LocalProxy 的一个使用场景是 LocalStack 的 <strong>call</strong> 方法。比如 my_local_stack 是一个 LocalStack 实例，那么 my_local_stack() 能返回一个 LocalProxy 对象，这个对象始终指向 my_local_stack 的栈顶元素。如果栈顶元素不存在，访问这个 LocalProxy 的时候会抛出 RuntimeError。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://xudalin0609.github.io/2017/01/01/openstack%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB(%E4%B8%80)/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Xu">
      <meta itemprop="description" content="独自发疯">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Relax And Slower">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2017/01/01/openstack%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB(%E4%B8%80)/" class="post-title-link" itemprop="url">OpenStack源码阅读(一)</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2017-01-01 00:00:00" itemprop="dateCreated datePublished" datetime="2017-01-01T00:00:00+08:00">2017-01-01</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-11-06 23:08:31" itemprop="dateModified" datetime="2023-11-06T23:08:31+08:00">2023-11-06</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/OpenStack/" itemprop="url" rel="index"><span itemprop="name">OpenStack</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="nova的构成"><a href="#nova的构成" class="headerlink" title="nova的构成"></a>nova的构成</h3><p>openstac由不同的组件构成，目前常用的组件有nova,cinder,glance,neutron等。组件之间采用restful-api进行通信，组件内部使用RPC进行通讯。</p>
<p>每个组件内部又分为不同的模块，以nova为例，可以分出的模块如下：</p>
<ul>
<li>nova api</li>
<li>nova compute</li>
<li>nova schedule</li>
<li>nova condutor</li>
</ul>
<h3 id="nova的内部的基本流程"><a href="#nova的内部的基本流程" class="headerlink" title="nova的内部的基本流程"></a>nova的内部的基本流程</h3><p>如果我向nova发送了一个create server的restful请求，nova内部会如何处理这个请求呢？大致的流程概括如下。</p>
<ol>
<li>nova api接受到请求，做出相应的校验，参数处理和资源准备，然后rpc调用nova-schduler</li>
<li>nova scheduler是虚拟机调度服务，选择合适的计算节点运行虚拟机，然后rpc调用nova-compute</li>
<li>nova compute是虚拟机的管理服务，通过调用hypervisor api实现虚拟机的生命周期管理，以kvm为例，就是使用libvert的api进行虚拟机生命周期管理，在过程中会对conductor进行调用</li>
<li>nova conductor和数据库进行交互（之所以使用nova conductor而不是nova compute直接和数据库交互是出于安全性和可伸缩性考虑）</li>
</ol>
<p>每个组件是如何实现的，具体做了哪些事情，以及为什么要这么实现，后面会继续尝试进行分析。</p>
<h3 id="nova-api的实现"><a href="#nova-api的实现" class="headerlink" title="nova api的实现"></a>nova api的实现</h3><p>nova api使用paste_deploy来帮助生成wsgi app。要理解nova api的实现，首先要理解paste deploy的使用方式。</p>
<p>简单的概括一下paste deploy是做什么的。PasteDeploy是一套发现和配置WSGI应用的系统。它根据指定的配置文件动态生成入口点和组织WSGI applieation间的逻辑关系。换成一个比较容易理解的方式来说，就是使用配置文件生成wsgi app并将它们组装起来。</p>
<p>来看一个最小的deploy使用demo</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"># config.ini</span><br><span class="line">[composite:main]</span><br><span class="line">use = call:urlmap:urlmap_factory</span><br><span class="line">/v1: router_v1 </span><br><span class="line"></span><br><span class="line">[composite:router_v1]</span><br><span class="line">use = call:router_v1:app_factory</span><br><span class="line">r1 = filter_v1 app_v1</span><br><span class="line"></span><br><span class="line">[filter:filter_v1]</span><br><span class="line">paste.filter_factory = filter_v1:filter_factory</span><br><span class="line"></span><br><span class="line">[app:app_v1]</span><br><span class="line">paste.app_factory = app_v1:app_factory</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># router_v1</span></span><br><span class="line"><span class="keyword">from</span> webob.dec <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> webob.exc</span><br><span class="line"><span class="keyword">from</span> routes <span class="keyword">import</span> Mapper, middleware</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">_load_pipeline</span>(<span class="params">loader, pipeline</span>):</span><br><span class="line">    filters = [loader.get_filter(n) <span class="keyword">for</span> n <span class="keyword">in</span> pipeline[:-<span class="number">1</span>]]</span><br><span class="line">    app = loader.get_app(pipeline[-<span class="number">1</span>])</span><br><span class="line">    filters.reverse()</span><br><span class="line">    <span class="keyword">for</span> <span class="built_in">filter</span> <span class="keyword">in</span> filters:</span><br><span class="line">        app = <span class="built_in">filter</span>(app)</span><br><span class="line">    <span class="keyword">return</span> app</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">app_factory</span>(<span class="params">loader, global_conf, **local_conf</span>):</span><br><span class="line">    pipeline = local_conf[<span class="string">&#x27;r1&#x27;</span>]</span><br><span class="line">    pipeline = pipeline.split()</span><br><span class="line">    <span class="keyword">return</span> _load_pipeline(loader, pipeline)</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># filter_v1</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add_str</span>(<span class="params">app</span>):</span><br><span class="line">    <span class="keyword">return</span> app + <span class="string">&quot;filter v1&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">filter_factory</span>(<span class="params">loader, **local_config</span>):</span><br><span class="line">    <span class="keyword">return</span> add_str</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># app_v1</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">app_factory</span>(<span class="params">loader, **local_config</span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;app v1&quot;</span></span><br></pre></td></tr></table></figure>


<p>从以上代码可以看到一个基本paste deploy的使用方式</p>
<ul>
<li>loadapp从配置文件中加载一个wsgi app</li>
<li>可以通过paste deploy传入的loader获取到不同的组件</li>
<li>将最终需要返回的app作为参数传入pipeline并经过层层处理</li>
</ul>
<p>对比nova api的实际配置文件如下：</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># nova/etc/nova</span></span><br><span class="line"><span class="section">[composite:osapi_compute]</span></span><br><span class="line"><span class="attr">use</span> = call:nova.api.openstack.urlmap:urlmap_factory</span><br><span class="line">/: oscomputeversions</span><br><span class="line">/v2: openstack_compute_api_v21_legacy_v2_compatible</span><br><span class="line">/v2.1: openstack_compute_api_v21</span><br><span class="line"></span><br><span class="line"><span class="section">[composite:openstack_compute_api_v21]</span></span><br><span class="line"><span class="attr">use</span> = call:nova.api.auth:pipeline_factory_v21</span><br><span class="line"><span class="attr">noauth2</span> = cors compute_req_id faultwrap sizelimit osprofiler noauth2 osapi_compute_app_v21</span><br><span class="line"><span class="attr">keystone</span> = cors compute_req_id faultwrap sizelimit osprofiler authtoken keystonecontext osapi_compute_app_v21</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>不难理解，nova api首先使用nova&#x2F;api&#x2F;openstack&#x2F;urlmap中的urlmap_factory函数根据版本对请求进行路由。路由的逻辑如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">urlmap_factory</span>(<span class="params">loader, global_conf, **local_conf</span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;not_found_app&#x27;</span> <span class="keyword">in</span> local_conf:</span><br><span class="line">        not_found_app = local_conf.pop(<span class="string">&#x27;not_found_app&#x27;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        not_found_app = global_conf.get(<span class="string">&#x27;not_found_app&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> not_found_app:</span><br><span class="line">        not_found_app = loader.get_app(not_found_app, global_conf=global_conf)</span><br><span class="line">    urlmap = URLMap(not_found_app=not_found_app)</span><br><span class="line">    <span class="keyword">for</span> path, app_name <span class="keyword">in</span> local_conf.items():</span><br><span class="line">        path = paste.urlmap.parse_path_expression(path)</span><br><span class="line">        app = loader.get_app(app_name, global_conf=global_conf)</span><br><span class="line">        urlmap[path] = app</span><br><span class="line">    <span class="keyword">return</span> urlmap</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">URLMap</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__call__</span>(<span class="params">self, environ, start_response</span>):</span><br><span class="line">        host = environ.get(<span class="string">&#x27;HTTP_HOST&#x27;</span>, environ.get(<span class="string">&#x27;SERVER_NAME&#x27;</span>)).lower()</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;:&#x27;</span> <span class="keyword">in</span> host:</span><br><span class="line">            host, port = host.split(<span class="string">&#x27;:&#x27;</span>, <span class="number">1</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">if</span> environ[<span class="string">&#x27;wsgi.url_scheme&#x27;</span>] == <span class="string">&#x27;http&#x27;</span>:</span><br><span class="line">                port = <span class="string">&#x27;80&#x27;</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                port = <span class="string">&#x27;443&#x27;</span></span><br><span class="line"></span><br><span class="line">        path_info = environ[<span class="string">&#x27;PATH_INFO&#x27;</span>]</span><br><span class="line">        path_info = self.normalize_url(path_info, <span class="literal">False</span>)[<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">        <span class="comment"># The MIME type for the response is determined in one of two ways:</span></span><br><span class="line">        <span class="comment"># 1) URL path suffix (eg /servers/detail.json)</span></span><br><span class="line">        <span class="comment"># 2) Accept header (eg application/json;q=0.8, application/xml;q=0.2)</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># The API version is determined in one of three ways:</span></span><br><span class="line">        <span class="comment"># 1) URL path prefix (eg /v1.1/tenant/servers/detail)</span></span><br><span class="line">        <span class="comment"># 2) Content-Type header (eg application/json;version=1.1)</span></span><br><span class="line">        <span class="comment"># 3) Accept header (eg application/json;q=0.8;version=1.1)</span></span><br><span class="line"></span><br><span class="line">        supported_content_types = <span class="built_in">list</span>(wsgi.get_supported_content_types())</span><br><span class="line"></span><br><span class="line">        mime_type, app, app_url = self._path_strategy(host, port, path_info)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Accept application/atom+xml for the index query of each API</span></span><br><span class="line">        <span class="comment"># version mount point as well as the root index</span></span><br><span class="line">        <span class="keyword">if</span> (app_url <span class="keyword">and</span> app_url + <span class="string">&#x27;/&#x27;</span> == path_info) <span class="keyword">or</span> path_info == <span class="string">&#x27;/&#x27;</span>:</span><br><span class="line">            supported_content_types.append(<span class="string">&#x27;application/atom+xml&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> app:</span><br><span class="line">            app = self._content_type_strategy(host, port, environ)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> mime_type <span class="keyword">or</span> <span class="keyword">not</span> app:</span><br><span class="line">            possible_mime_type, possible_app = self._accept_strategy(</span><br><span class="line">                    host, port, environ, supported_content_types)</span><br><span class="line">            <span class="keyword">if</span> possible_mime_type <span class="keyword">and</span> <span class="keyword">not</span> mime_type:</span><br><span class="line">                mime_type = possible_mime_type</span><br><span class="line">            <span class="keyword">if</span> possible_app <span class="keyword">and</span> <span class="keyword">not</span> app:</span><br><span class="line">                app = possible_app</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> mime_type:</span><br><span class="line">            mime_type = <span class="string">&#x27;application/json&#x27;</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> app:</span><br><span class="line">            <span class="comment"># Didn&#x27;t match a particular version, probably matches default</span></span><br><span class="line">            app, app_url = self._<span class="keyword">match</span>(host, port, path_info)</span><br><span class="line">            <span class="keyword">if</span> app:</span><br><span class="line">                app = self._munge_path(app, path_info, app_url)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> app:</span><br><span class="line">            environ[<span class="string">&#x27;nova.best_content_type&#x27;</span>] = mime_type</span><br><span class="line">            <span class="keyword">return</span> app(environ, start_response)</span><br><span class="line"></span><br><span class="line">        LOG.debug(<span class="string">&#x27;Could not find application for %s&#x27;</span>, environ[<span class="string">&#x27;PATH_INFO&#x27;</span>])</span><br><span class="line">        environ[<span class="string">&#x27;paste.urlmap_object&#x27;</span>] = self</span><br><span class="line">        <span class="keyword">return</span> self.not_found_application(environ, start_response)</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>以上的URLMap只保留了__call__部分的代码，可以看出URLMap实现了根据不同的版本信息路由到不同的不同的组件中。假设使用的版本为v21，继续openstack_compute_api_v21实现了那些功能。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">_load_pipeline</span>(<span class="params">loader, pipeline</span>):</span><br><span class="line">    filters = [loader.get_filter(n) <span class="keyword">for</span> n <span class="keyword">in</span> pipeline[:-<span class="number">1</span>]]</span><br><span class="line">    app = loader.get_app(pipeline[-<span class="number">1</span>])</span><br><span class="line">    filters.reverse()</span><br><span class="line">    <span class="keyword">for</span> <span class="built_in">filter</span> <span class="keyword">in</span> filters:</span><br><span class="line">        app = <span class="built_in">filter</span>(app)</span><br><span class="line">    <span class="keyword">return</span> app</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pipeline_factory</span>(<span class="params">loader, global_conf, **local_conf</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;A paste pipeline replica that keys off of auth_strategy.&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    pipeline = local_conf[CONF.auth_strategy]</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> CONF.api_rate_limit:</span><br><span class="line">        limit_name = CONF.auth_strategy + <span class="string">&#x27;_nolimit&#x27;</span></span><br><span class="line">        pipeline = local_conf.get(limit_name, pipeline)</span><br><span class="line">    pipeline = pipeline.split()</span><br><span class="line">    <span class="keyword">return</span> _load_pipeline(loader, pipeline)</span><br></pre></td></tr></table></figure>
<p>这一段的逻辑也不难理解，pipeline实现了加载配置文件中的所有filter并将app作为参数逐层传入filter中。跳过filter中的内容，下一步直接跳入到最后的app，看一下app是如何实现的。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># nova/api/openstack/compute/__init__.py</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">APIRouterV21</span>(nova.api.openstack.APIRouterV21):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Routes requests on the OpenStack API to the appropriate controller</span></span><br><span class="line"><span class="string">    and method.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, init_only=<span class="literal">None</span></span>):</span><br><span class="line">        self._loaded_extension_info = extension_info.LoadedExtensionInfo()</span><br><span class="line">        <span class="built_in">super</span>(APIRouterV21, self).__init__(init_only)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_register_extension</span>(<span class="params">self, ext</span>):</span><br><span class="line">        <span class="keyword">return</span> self.loaded_extension_info.register_extension(ext.obj)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">loaded_extension_info</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> self._loaded_extension_info</span><br></pre></td></tr></table></figure>
<p>这里的实现了很少的逻辑，只加载了一个extensionInfo，主要参数由它的父类实现，继续看父类代码。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">APIRouterV21</span>(base_wsgi.Router):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Routes requests on the OpenStack v2.1 API to the appropriate controller</span></span><br><span class="line"><span class="string">    and method.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">factory</span>(<span class="params">cls, global_config, **local_config</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Simple paste factory, :class:`nova.wsgi.Router` doesn&#x27;t have one.&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> cls()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, init_only=<span class="literal">None</span>, v3mode=<span class="literal">False</span></span>):</span><br><span class="line">        self.api_extension_manager = stevedore.enabled.EnabledExtensionManager(</span><br><span class="line">            namespace=self.api_extension_namespace(),</span><br><span class="line">            check_func=_check_load_extension,</span><br><span class="line">            invoke_on_load=<span class="literal">True</span>,</span><br><span class="line">            invoke_kwds=&#123;<span class="string">&quot;extension_info&quot;</span>: self.loaded_extension_info&#125;)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> v3mode:</span><br><span class="line">            mapper = PlainMapper()</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            mapper = ProjectMapper()</span><br><span class="line"></span><br><span class="line">        self.resources = &#123;&#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"># NOTE(cyeoh) Core API support is rewritten as extensions</span></span><br><span class="line">        <span class="comment"># but conceptually still have core</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">list</span>(self.api_extension_manager):</span><br><span class="line">            <span class="comment"># NOTE(cyeoh): Stevedore raises an exception if there are</span></span><br><span class="line">            <span class="comment"># no plugins detected. I wonder if this is a bug.</span></span><br><span class="line">            self._register_resources_check_inherits(mapper)</span><br><span class="line">            self.api_extension_manager.<span class="built_in">map</span>(self._register_controllers)</span><br><span class="line"></span><br><span class="line">        missing_core_extensions = self.get_missing_core_extensions(</span><br><span class="line">            self.loaded_extension_info.get_extensions().keys())</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self.init_only <span class="keyword">and</span> missing_core_extensions:</span><br><span class="line">            LOG.critical(_LC(<span class="string">&quot;Missing core API extensions: %s&quot;</span>),</span><br><span class="line">                         missing_core_extensions)</span><br><span class="line">            <span class="keyword">raise</span> exception.CoreAPIMissing(</span><br><span class="line">                missing_apis=missing_core_extensions)</span><br><span class="line"></span><br><span class="line">        LOG.info(_LI(<span class="string">&quot;Loaded extensions: %s&quot;</span>),</span><br><span class="line">                 <span class="built_in">sorted</span>(self.loaded_extension_info.get_extensions().keys()))</span><br><span class="line">        <span class="built_in">super</span>(APIRouterV21, self).__init__(mapper)</span><br></pre></td></tr></table></figure>
<p>删除了部分校验相关代码，可以看到这个类主要实现了对于mapper的初始化，并且使用stevedore加载了了一个api_extension_manager。然后使用api_extension_manager将resources注册进了mapper中。继续看他的父类。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Router</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;WSGI middleware that maps incoming requests to WSGI apps.&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, mapper</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Create a router for the given routes.Mapper.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Each route in `mapper` must specify a &#x27;controller&#x27;, which is a</span></span><br><span class="line"><span class="string">        WSGI app to call.  You&#x27;ll probably want to specify an &#x27;action&#x27; as</span></span><br><span class="line"><span class="string">        well and have your controller be an object that can route</span></span><br><span class="line"><span class="string">        the request to the action-specific method.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Examples:</span></span><br><span class="line"><span class="string">          mapper = routes.Mapper()</span></span><br><span class="line"><span class="string">          sc = ServerController()</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">          # Explicit mapping of one route to a controller+action</span></span><br><span class="line"><span class="string">          mapper.connect(None, &#x27;/svrlist&#x27;, controller=sc, action=&#x27;list&#x27;)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">          # Actions are all implicitly defined</span></span><br><span class="line"><span class="string">          mapper.resource(&#x27;server&#x27;, &#x27;servers&#x27;, controller=sc)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">          # Pointing to an arbitrary WSGI app.  You can specify the</span></span><br><span class="line"><span class="string">          # &#123;path_info:.*&#125; parameter so the target app can be handed just that</span></span><br><span class="line"><span class="string">          # section of the URL.</span></span><br><span class="line"><span class="string">          mapper.connect(None, &#x27;/v1.0/&#123;path_info:.*&#125;&#x27;, controller=BlogApp())</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        self.<span class="built_in">map</span> = mapper</span><br><span class="line">        self._router = routes.middleware.RoutesMiddleware(self._dispatch,</span><br><span class="line">                                                          self.<span class="built_in">map</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @webob.dec.wsgify(<span class="params">RequestClass=Request</span>)</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__call__</span>(<span class="params">self, req</span>):</span><br><span class="line">        <span class="keyword">return</span> self._router</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line"><span class="meta">    @webob.dec.wsgify(<span class="params">RequestClass=Request</span>)</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_dispatch</span>(<span class="params">req</span>):</span><br><span class="line">        <span class="keyword">match</span> = req.environ[<span class="string">&#x27;wsgiorg.routing_args&#x27;</span>][<span class="number">1</span>]</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="keyword">match</span>:</span><br><span class="line">            <span class="keyword">return</span> webob.exc.HTTPNotFound()</span><br><span class="line">        app = <span class="keyword">match</span>[<span class="string">&#x27;controller&#x27;</span>]</span><br><span class="line">        <span class="keyword">return</span> app</span><br></pre></td></tr></table></figure>
<p>实现了wsgi app约定的__call__方法，返回了router，rotuer的功能就是将地址路由到具体的函数中。至此一个url及其匹配的处理函数就已经被找到了，但是还有一个问题，api_extension_manager中都有些什么东西。这里用到了stevedore的动态加载功能，stevedore根据配置文件，将不同的资源初始化到不同的命名空间中，使用的过程中，指定命名空间，并加载对应的source就可以了,以server的resource为例。</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">nova.api.v21.extensions </span><br><span class="line">    <span class="attr">servers</span> = nova.api.openstack.compute.servers:Servers</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Servers</span>(extensions.V21APIExtensionBase):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Servers.&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    name = <span class="string">&quot;Servers&quot;</span></span><br><span class="line">    alias = ALIAS</span><br><span class="line">    version = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_resources</span>(<span class="params">self</span>):</span><br><span class="line">        member_actions = &#123;<span class="string">&#x27;action&#x27;</span>: <span class="string">&#x27;POST&#x27;</span>, <span class="string">&#x27;disk&#x27;</span>: <span class="string">&#x27;GET&#x27;</span>&#125;</span><br><span class="line">        collection_actions = &#123;<span class="string">&#x27;detail&#x27;</span>: <span class="string">&#x27;GET&#x27;</span>&#125;</span><br><span class="line">        resources = [</span><br><span class="line">            extensions.ResourceExtension(</span><br><span class="line">                ALIAS,</span><br><span class="line">                ServersController(extension_info=self.extension_info),</span><br><span class="line">                member_name=<span class="string">&#x27;server&#x27;</span>, collection_actions=collection_actions,</span><br><span class="line">                member_actions=member_actions)]</span><br><span class="line"></span><br><span class="line">        res = extensions.ResourceExtension(<span class="string">&#x27;os-get_servers_info&#x27;</span>,</span><br><span class="line">                                           GetServersInfoController())</span><br><span class="line">        resources.append(res)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> resources</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_controller_extensions</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> []</span><br></pre></td></tr></table></figure>
<p>至此，nova-api的基本逻辑就基本完成了，其中仍有很多细节，需要阅读具体的代码，后续会继续整理nova其他组件的代码。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://xudalin0609.github.io/2017/01/01/%E4%B8%BA%E4%BB%80%E4%B9%88%E6%88%91%E4%BB%AC%E9%9C%80%E8%A6%81TCP(%E4%B8%89)/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Xu">
      <meta itemprop="description" content="独自发疯">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Relax And Slower">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2017/01/01/%E4%B8%BA%E4%BB%80%E4%B9%88%E6%88%91%E4%BB%AC%E9%9C%80%E8%A6%81TCP(%E4%B8%89)/" class="post-title-link" itemprop="url">为什么我们需要TCP(三)</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2017-01-01 00:00:00" itemprop="dateCreated datePublished" datetime="2017-01-01T00:00:00+08:00">2017-01-01</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-11-06 23:10:52" itemprop="dateModified" datetime="2023-11-06T23:10:52+08:00">2023-11-06</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E7%BD%91%E7%BB%9C/" itemprop="url" rel="index"><span itemprop="name">网络</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="为什么我们需要-TCP（三）"><a href="#为什么我们需要-TCP（三）" class="headerlink" title="为什么我们需要 TCP（三）"></a>为什么我们需要 TCP（三）</h1><p>之前我们讨论了问什么需要 TCP 和 TCP 是如何创建有效连接的，接下来我们继续思考一下，TCP 的连接是如何安全的断开的。要回答这个问题，我们首先要知道，为什么 TCP 的断开需要解决什么问题。</p>
<h4 id="场景模拟"><a href="#场景模拟" class="headerlink" title="场景模拟"></a>场景模拟</h4><p>在 A、B 之间已经创建了一个有效的 TCP 连接，然后，A 决定断开这次连接。</p>
<ul>
<li><p>情况 1：A 单方面解除了此次连接，不再接受 B 传来的报文段了。<br>很容易猜到结果，B 仍在傻傻的发送报文段，A 却没有接到，于是部分内容丢失了，连接不安全了。为了解决这个问题，A 需要告诉 B，“别发了别发了，我们结束了”。</p>
</li>
<li><p>情况 2：A 告诉 B，“我要断开连接了，你别发信息了”。但是<strong>网络是不稳定的</strong>，所以 B 没收到。A 过了一会没得到 B 的答复，就又发了一次，“我要断开连接了，你别发信息了”。这次 B 收到了，于是和 A 说，“我知道了，不过你得等会儿哈，我还有点儿东西没发完。”过了一会儿，B 的东西都发完了，就主动和 A 说，“得嘞，都发完了，再见！”。这时 B 就可以断开了么？记住，<strong>网络是不稳定的</strong>，所以如果此时 B 就断开了，那出现了报文段丢失就没办法了，所以 B 还得等着，等到确认 A 所有内容都收到了才能断开。</p>
</li>
<li><p>情况 3：A 告诉 B，“我要断开连接了，你别发信息了”。B 和 A 说，“我知道了，不过你得等会哈，我还有点儿东西没发完。”过了一会儿，B 主动和 A 说“得嘞，都发完了，等你都收到了，我就断开了”。说完，B 就开始等着 A 的回复了。A 每收到一个报文段就和 B 发送一个 ack，当 B 发现 A 收到最后一个报文段了，B 就安心的断开了。（如果发现报文段丢失则会重发）。A 等了一阵儿，也发现不会再收到报文段了，就也断开了连接。至此连接结束。</p>
</li>
</ul>
<p>以上就是四次挥手的基本流程了。概括一下。</p>
<ol>
<li>A 发起的断开连接的请求。</li>
<li>B 向 A 发送“确认收到”</li>
<li>过了一会儿，B 向 A 发送“数据包发送完成”</li>
<li>B 收到了 A 的全部接收确认后断开连接，A 过了一段儿时间后断开连接。</li>
</ol>
<h4 id="四次挥手真的是安全的么？"><a href="#四次挥手真的是安全的么？" class="headerlink" title="四次挥手真的是安全的么？"></a>四次挥手真的是安全的么？</h4><p>以下内容只是我的猜测，没有阅读到相关文档，待确认</p>
<p>假设 1：现在的网络状态极差</p>
<p>假设 2：现在处于断开连接的第四步(B 收到了 A 的全部接收确认后断开连接，A 过了一段儿时间后断开连接。)</p>
<p><del>如果 B 向 A 发送的报文段全部丢失，当过了一段时间后，A 会自动关闭连接，这是不是意味着部分报文段丢失了呢？ </del></p>
<p>这里我出现了一个很愚蠢的错误，B只有接收到A的全部ack之后才会断开连接，这表示A并没有丢失掉报文段。那么既然A已经接收到了全部的报文段，又为什么要等一会儿在断开连接呢？</p>
<p>原因一：<br>    历史的报文段是有可能延迟抵达的，如果A没有等待直接关闭了连接，当迷路的报文段抵达时有可能会被其他连接错误的处理。所以A需要等待一会儿(这个时间为2WSL)，确保历史的报文段都抵达了。（如果报文段的传输时间超过2WSL会被废弃）</p>
<p>原因二：</p>
<h4 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h4><ul>
<li>为了连接的安全断开，断开的发起方需要确认所有的报文都被接受完毕</li>
<li>断开的被动方接收到断开的请求后，需要等待所有报文发送完毕后主动通知发起方</li>
</ul>
<p>以上只是四次挥手的基本流程，具体会有一些关于标志字段的细节和可调参数，后续会继续完善本文档。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://xudalin0609.github.io/2017/01/01/flask%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB(%E4%BA%8C)/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Xu">
      <meta itemprop="description" content="独自发疯">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Relax And Slower">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2017/01/01/flask%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB(%E4%BA%8C)/" class="post-title-link" itemprop="url">flask源码阅读(二)</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2017-01-01 00:00:00" itemprop="dateCreated datePublished" datetime="2017-01-01T00:00:00+08:00">2017-01-01</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-11-06 23:06:33" itemprop="dateModified" datetime="2023-11-06T23:06:33+08:00">2023-11-06</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Flask/" itemprop="url" rel="index"><span itemprop="name">Flask</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="flask是如何生成response的"><a href="#flask是如何生成response的" class="headerlink" title="flask是如何生成response的"></a>flask是如何生成response的</h1><p>在之前分析flask是如何启动的过程中看到，wsgi_app（）函数返回了response，但是如何寻找到对应的业务处理函数（路由），并生成response的，被略过了，这里继续进行分析。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">wsgi_app</span>(<span class="params">self, environ, start_response</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;The actual WSGI application.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    ctx = self.request_context(environ)</span><br><span class="line">    ctx.push()</span><br><span class="line">    error = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            response = self.full_dispatch_request()</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            response = self.handle_exception(e)</span><br><span class="line">        <span class="keyword">return</span> response(environ, start_response)</span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        <span class="keyword">if</span> self.should_ignore_error(error):</span><br><span class="line">            error = <span class="literal">None</span></span><br><span class="line">        ctx.auto_pop(error)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>前文使用的代码是0.1版本的，但是由于wsgi_app（）函数在0.1版本不够清晰，这里之后使用0.12版本代码进行分析</p>
</blockquote>
<p>逐行分析这段函数，首先是调用了一个request_context()，生成了一个请求上下文对象，然后将这个对象压入栈(关于请求上下文的分析后面继续)。</p>
<p>接下来调用full_dispatch_request()生成response。</p>
<p>最后将request传入的参数传入response对象并返回response。具体来看一下full_dispatch_request()做了些什么</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">full_dispatch_request</span>(<span class="params">self</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Dispatches the request and on top of that performs request</span></span><br><span class="line"><span class="string">    pre and postprocessing as well as HTTP exception catching and</span></span><br><span class="line"><span class="string">    error handling.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    .. versionadded:: 0.7</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    self.try_trigger_before_first_request_functions()</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        request_started.send(self)</span><br><span class="line">        rv = self.preprocess_request()</span><br><span class="line">        <span class="keyword">if</span> rv <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            rv = self.dispatch_request()</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        rv = self.handle_user_exception(e)</span><br><span class="line">    <span class="keyword">return</span> self.finalize_request(rv)</span><br></pre></td></tr></table></figure>
<p>做了三件事情：</p>
<ol>
<li>调用try_trigger_before_first_request_functions()(具体实现了什么暂且搁置)</li>
<li>调用request_started.send(self)(搁置)</li>
<li>调用prepross_request()生成了rv，如果rv为空则调用self.dispatch_reqeust()</li>
<li>调用finilize_request(rv)，将rv作为参数传入</li>
</ol>
<p>抛开代码细节，这里我的疑问主要是，rv是什么？和我们路由到业务函数之间有什么联系？</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">preprocess_request</span>(<span class="params">self</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Called before the actual request dispatching and will</span></span><br><span class="line"><span class="string">    call each :meth:`before_request` decorated function, passing no</span></span><br><span class="line"><span class="string">    arguments.</span></span><br><span class="line"><span class="string">    If any of these functions returns a value, it&#x27;s handled as</span></span><br><span class="line"><span class="string">    if it was the return value from the view and further</span></span><br><span class="line"><span class="string">    request handling is stopped.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    This also triggers the :meth:`url_value_preprocessor` functions before</span></span><br><span class="line"><span class="string">    the actual :meth:`before_request` functions are called.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    bp = _request_ctx_stack.top.request.blueprint</span><br><span class="line"></span><br><span class="line">    funcs = self.url_value_preprocessors.get(<span class="literal">None</span>, ())</span><br><span class="line">    <span class="keyword">if</span> bp <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span> <span class="keyword">and</span> bp <span class="keyword">in</span> self.url_value_preprocessors:</span><br><span class="line">        funcs = chain(funcs, self.url_value_preprocessors[bp])</span><br><span class="line">    <span class="keyword">for</span> func <span class="keyword">in</span> funcs:</span><br><span class="line">        func(request.endpoint, request.view_args)</span><br><span class="line"></span><br><span class="line">    funcs = self.before_request_funcs.get(<span class="literal">None</span>, ())</span><br><span class="line">    <span class="keyword">if</span> bp <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span> <span class="keyword">and</span> bp <span class="keyword">in</span> self.before_request_funcs:</span><br><span class="line">        funcs = chain(funcs, self.before_request_funcs[bp])</span><br><span class="line">    <span class="keyword">for</span> func <span class="keyword">in</span> funcs:</span><br><span class="line">        rv = func()</span><br><span class="line">        <span class="keyword">if</span> rv <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">return</span> rv</span><br></pre></td></tr></table></figure>
<p>返回的rv的过程中，preprocess_request()做了几件事情</p>
<ol>
<li>获取bp(即blueprint)</li>
<li>调用url_value_preprocessors.get(),获取funcs（猜测此处为业务函数, 但是<strong>此处及后面的的key都是None</strong>,所以返回的都是()）</li>
<li>迭代所获取到的funcs，传入endpoint和views_args(注意到此处的参数是通过request获取到的，那么request又是哪里来的？)</li>
<li>调用before_request_funcs获取funcs</li>
<li>迭代funcs，返回rv或None</li>
</ol>
<p>不去纠结preprocess_request()的细节,去看接下来当rv为None时,dispatch_requst()做了些什么</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">dispatch_request</span>(<span class="params">self</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Does the request dispatching.  Matches the URL and returns the</span></span><br><span class="line"><span class="string">    return value of the view or error handler.  This does not have to</span></span><br><span class="line"><span class="string">    be a response object.  In order to convert the return value to a</span></span><br><span class="line"><span class="string">    proper response object, call :func:`make_response`.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    .. versionchanged:: 0.7</span></span><br><span class="line"><span class="string">       This no longer does the exception handling, this code was</span></span><br><span class="line"><span class="string">       moved to the new :meth:`full_dispatch_request`.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    req = _request_ctx_stack.top.request</span><br><span class="line">    <span class="keyword">if</span> req.routing_exception <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">        self.raise_routing_exception(req)</span><br><span class="line">    rule = req.url_rule</span><br><span class="line">    <span class="comment"># if we provide automatic options for this URL and the</span></span><br><span class="line">    <span class="comment"># request came with the OPTIONS method, reply automatically</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">getattr</span>(rule, <span class="string">&#x27;provide_automatic_options&#x27;</span>, <span class="literal">False</span>) \</span><br><span class="line">       <span class="keyword">and</span> req.method == <span class="string">&#x27;OPTIONS&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> self.make_default_options_response()</span><br><span class="line">    <span class="comment"># otherwise dispatch to the handler for that endpoint</span></span><br><span class="line">    <span class="keyword">return</span> self.view_functions[rule.endpoint](**req.view_args)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ol>
<li>从栈顶获取到request</li>
<li>获取request的rule</li>
<li>从self.view_functions返回业务函数的运行结果,传入req.view_args</li>
</ol>
<p>现在问题变成了</p>
<ul>
<li>reqeust什么时候生成并入栈的?</li>
<li>view_functions什么时候生成的,是什么?</li>
</ul>
<p>问题一</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">wsgi_app</span>(<span class="params">self, environ, start_response</span>):</span><br><span class="line">    <span class="comment"># 使用environ生了request的上下文对象并入栈了</span></span><br><span class="line">    ctx = self.request_context(environ)</span><br><span class="line">    error = <span class="literal">None</span></span><br><span class="line">    ...</span><br></pre></td></tr></table></figure>

<p>问题二<br>还记的flask的基本用法么</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">@app.route(&#x27;/&#x27;)</span><br><span class="line">def hello_world():</span><br><span class="line">    return &#x27;Hello, World!&#x27;</span><br></pre></td></tr></table></figure>
<p>但我们调用route装饰器的时候就已经往view_functions里添加了一个k:v,代码如下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">def</span> <span class="title function_">route</span>(<span class="params">self, rule, **options</span>):</span><br><span class="line">     <span class="keyword">def</span> <span class="title function_">decorator</span>(<span class="params">f</span>):</span><br><span class="line">         endpoint = options.pop(<span class="string">&#x27;endpoint&#x27;</span>, <span class="literal">None</span>)</span><br><span class="line">         self.add_url_rule(rule, endpoint, f, **options)</span><br><span class="line">         <span class="keyword">return</span> f</span><br><span class="line">     <span class="keyword">return</span> decorator</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add_url_rule</span>(<span class="params">self, rule, endpoint=<span class="literal">None</span>, view_func=<span class="literal">None</span>, **options</span>):</span><br><span class="line">   </span><br><span class="line">     <span class="keyword">if</span> endpoint <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">         endpoint = _endpoint_from_view_func(view_func)</span><br><span class="line">     options[<span class="string">&#x27;endpoint&#x27;</span>] = endpoint</span><br><span class="line">     methods = options.pop(<span class="string">&#x27;methods&#x27;</span>, <span class="literal">None</span>)</span><br><span class="line"></span><br><span class="line">     <span class="comment"># if the methods are not given and the view_func object knows its</span></span><br><span class="line">     <span class="comment"># methods we can use that instead.  If neither exists, we go with</span></span><br><span class="line">     <span class="comment"># a tuple of only ``GET`` as default.</span></span><br><span class="line">     <span class="keyword">if</span> methods <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">         methods = <span class="built_in">getattr</span>(view_func, <span class="string">&#x27;methods&#x27;</span>, <span class="literal">None</span>) <span class="keyword">or</span> (<span class="string">&#x27;GET&#x27;</span>,)</span><br><span class="line">     <span class="keyword">if</span> <span class="built_in">isinstance</span>(methods, string_types):</span><br><span class="line">         <span class="keyword">raise</span> TypeError(<span class="string">&#x27;Allowed methods have to be iterables of strings, &#x27;</span></span><br><span class="line">                         <span class="string">&#x27;for example: @app.route(..., methods=[&quot;POST&quot;])&#x27;</span>)</span><br><span class="line">     methods = <span class="built_in">set</span>(item.upper() <span class="keyword">for</span> item <span class="keyword">in</span> methods)</span><br><span class="line"></span><br><span class="line">     <span class="comment"># Methods that should always be added</span></span><br><span class="line">     required_methods = <span class="built_in">set</span>(<span class="built_in">getattr</span>(view_func, <span class="string">&#x27;required_methods&#x27;</span>, ()))</span><br><span class="line"></span><br><span class="line">     <span class="comment"># starting with Flask 0.8 the view_func object can disable and</span></span><br><span class="line">     <span class="comment"># force-enable the automatic options handling.</span></span><br><span class="line">     provide_automatic_options = <span class="built_in">getattr</span>(view_func,</span><br><span class="line">         <span class="string">&#x27;provide_automatic_options&#x27;</span>, <span class="literal">None</span>)</span><br><span class="line"></span><br><span class="line">     <span class="keyword">if</span> provide_automatic_options <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">         <span class="keyword">if</span> <span class="string">&#x27;OPTIONS&#x27;</span> <span class="keyword">not</span> <span class="keyword">in</span> methods:</span><br><span class="line">             provide_automatic_options = <span class="literal">True</span></span><br><span class="line">             required_methods.add(<span class="string">&#x27;OPTIONS&#x27;</span>)</span><br><span class="line">         <span class="keyword">else</span>:</span><br><span class="line">             provide_automatic_options = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">     <span class="comment"># Add the required methods now.</span></span><br><span class="line">     methods |= required_methods</span><br><span class="line"></span><br><span class="line">     rule = self.url_rule_class(rule, methods=methods, **options)</span><br><span class="line">     rule.provide_automatic_options = provide_automatic_options</span><br><span class="line"></span><br><span class="line">     self.url_map.add(rule)</span><br><span class="line">     <span class="keyword">if</span> view_func <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">         old_func = self.view_functions.get(endpoint)</span><br><span class="line">         <span class="keyword">if</span> old_func <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span> <span class="keyword">and</span> old_func != view_func:</span><br><span class="line">             <span class="keyword">raise</span> AssertionError(<span class="string">&#x27;View function mapping is overwriting an &#x27;</span></span><br><span class="line">                                  <span class="string">&#x27;existing endpoint function: %s&#x27;</span> % endpoint)</span><br><span class="line">         self.view_functions[endpoint] = view_func</span><br></pre></td></tr></table></figure>

<p>上面的函数中我们可以看到flask维护了url_map和view_functions两个映射关系,前者是werkzeug中的Map对象,匹配url返回对应的endpoint名字和字典参数.view_functions维护的是endpoint到业务处理函数之间的关系.</p>
<p>总结一下,flask找到对应的业务函数(路由)过程可以概括为:</p>
<ol>
<li>使用route或者add_rule_url添加映射关系到url_map和view_functions</li>
<li>请求(request)进来之后,通过request的信息匹配到对应的业务处理函数,并返回调用结果</li>
<li>使用业务函数的结果生成响应(response)对象,并返回给wsgi服务</li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://xudalin0609.github.io/2017/01/01/%E4%B8%BA%E4%BB%80%E4%B9%88%E6%88%91%E4%BB%AC%E9%9C%80%E8%A6%81TCP(%E4%BA%8C)/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Xu">
      <meta itemprop="description" content="独自发疯">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Relax And Slower">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2017/01/01/%E4%B8%BA%E4%BB%80%E4%B9%88%E6%88%91%E4%BB%AC%E9%9C%80%E8%A6%81TCP(%E4%BA%8C)/" class="post-title-link" itemprop="url">为什么我们需要TCP(二)</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2017-01-01 00:00:00" itemprop="dateCreated datePublished" datetime="2017-01-01T00:00:00+08:00">2017-01-01</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-11-06 23:10:32" itemprop="dateModified" datetime="2023-11-06T23:10:32+08:00">2023-11-06</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E7%BD%91%E7%BB%9C/" itemprop="url" rel="index"><span itemprop="name">网络</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="为什么我们需要TCP（二）"><a href="#为什么我们需要TCP（二）" class="headerlink" title="为什么我们需要TCP（二）"></a>为什么我们需要TCP（二）</h1><p>在为什么我们需要TCP（一）中我们讨论了TCP是如何保证连接是可靠的，但是如何建立一个连接并没有讨论。这次继续这个问题进行思考。</p>
<h4 id="建立连接要面对的问题"><a href="#建立连接要面对的问题" class="headerlink" title="建立连接要面对的问题"></a>建立连接要面对的问题</h4><p>现在有A、B两台机器需要建立一个的连接，A尝试着向B发出一个请求连接的信号。想象一下都有什么可能发生？</p>
<ol>
<li>B收到了请求，A、B建立起了一个连接，A向B发送字节流</li>
<li>B没收到，A、B没有建立起连接，但是A并不知道B没收到，A向B发送字节流，结果全部石沉大海。</li>
</ol>
<p>怎么解决这个问题？很简单，如果B收到了回复给A一个确认的信号，A收到回复才会继续发送字节流。但是如果过了很久B还没有回复呢？A再发送一次连接请求就好了。问题看似得到了解决，但是又引入了新的问题。考虑一下A&#x3D;&gt;B,B&#x3D;&gt;A的连接模式下都可能发生什么？</p>
<ol>
<li>B收到了请求，回复给A，A、B建立起了一个连接，A向B发送字节流</li>
<li>B没收到了请求，A过了很久没收到请求，又重新发起了一次请求，这次B收到并回复了，A、B建立起了连接</li>
<li>B没收到了请求，A过了很久没收到请求，又重新发起了一次请求，然后B收到了第一次的请求，B和很久之前的A建立了连接，然后。。。A、B都懵逼了</li>
</ol>
<p>怎么办？这时候我们就需要第三次确认了，B在回复的时候告诉A我接收到的是第n号连接，A就可以据此判断这是不是历史连接并决定是否建立这次连接。</p>
<h4 id="用什么来交流"><a href="#用什么来交流" class="headerlink" title="用什么来交流"></a>用什么来交流</h4><p>在之前的内容中我们模拟了一系列情况用于分析为何需要三次确认（即三次握手），但是模糊掉了一些内容：</p>
<ol>
<li><p>A向B发送了些什么</p>
<p> A首先向B发送了一个包,告诉B“请求创建一个连接”。包含着CTL&#x3D;SYN(表示synchronous建立连接)和一个随机的seq值，比如seq&#x3D;n（还记么？就是上一篇提到的，用于给包裹排序的标签）。</p>
</li>
<li><p>B返回了什么</p>
<p> B会返回一个CTL&#x3D;ACK（表示acknowledgement 确认）返回一个ack&#x3D;n+1(即接收到的seq+1)。同时生成一个新的seq&#x3D;m的随机值</p>
</li>
<li><p>A如何根据B的返回判断B收到的是不是历史连接</p>
<p> A收到B返回的ack就可以对比是否等于自己最近发送出去的seq+1，相等则认为这次连接是有效的，不相等则认为B收到了历史连接，发送信息告诉B这是无效的。</p>
</li>
</ol>
<h4 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h4><ul>
<li>三次握手保证了我们创建的连接是有效的（不会重复建立历史连接）</li>
<li>三次握手初始化了服务器和客户端各自的seq字段，初始化了客户端的ack字段</li>
</ul>
<p>由于网络的承载能力是有限的，如果把所有的数据包都一股脑儿的塞到网络中就会导致拥堵，如果网络情况很好，但是接收方的能力有限，又会把接收方的撑坏。因此TCP又设计了不同的方法来解决这些问题，下次继续讨论。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://xudalin0609.github.io/2017/01/01/%E4%BB%80%E4%B9%88%E6%98%AF%E8%BF%9B%E7%A8%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Xu">
      <meta itemprop="description" content="独自发疯">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Relax And Slower">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2017/01/01/%E4%BB%80%E4%B9%88%E6%98%AF%E8%BF%9B%E7%A8%8B/" class="post-title-link" itemprop="url">什么是进程</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2017-01-01 00:00:00" itemprop="dateCreated datePublished" datetime="2017-01-01T00:00:00+08:00">2017-01-01</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-11-06 23:09:38" itemprop="dateModified" datetime="2023-11-06T23:09:38+08:00">2023-11-06</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%85%B6%E4%BB%96/" itemprop="url" rel="index"><span itemprop="name">其他</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="什么是进程"><a href="#什么是进程" class="headerlink" title="什么是进程"></a>什么是进程</h2><p>要回答这个问题，首先要清楚，我们在思考哪些问题？</p>
<ol>
<li>我们已经有程序这个概念的，为什么要搞出来一个进程？</li>
<li>进程做了什么事情？</li>
<li>进程是如何被创建的？</li>
</ol>
<h3 id="进程和程序的区别"><a href="#进程和程序的区别" class="headerlink" title="进程和程序的区别"></a>进程和程序的区别</h3><p>首先我们具体的思考一下什么是程序。在日常使用中的许多东西，比如浏览器，播放器等等一系列内容我们都称之为程序。</p>
<p>但是当我们查看系统的进程时，会发现并不是所有已安装的程序都会出现，只有部分运行中的程序才会被创建一个进程。也就是说，程序只是指令的集合，当它被运行起来后，我们就有了进程。</p>
<p>我们也可以从另外的角度描述这件事，操作系统使用为程序创建了一个进程。</p>
<p>OK，此时我们起始已经解决了第一个问题，程序本身只是个静态的东西，操作系统使其动了起来，动起来的程序就是进程。</p>
<h3 id="进程做了些什么"><a href="#进程做了些什么" class="headerlink" title="进程做了些什么"></a>进程做了些什么</h3><p>当回答了第一个问题后，便会发现，这个问题并不准确。更合适的提问方式应该是，操作系统对程序做了什么，使其成为了进程。</p>
<p>让我用一个并不严谨的公式模拟<strong>程序</strong>变成<strong>进程</strong>的过程：</p>
<p>程序+X1+X2+… &#x3D; 进程</p>
<p>其中的X1，X2等未知变量就是操作系统加到程序上的东西，也是我们要找的答案。</p>
<h4 id="X1：内存"><a href="#X1：内存" class="headerlink" title="X1：内存"></a>X1：内存</h4><p>一个程序本身一定是不拥有内存空间的，但是进程是拥有内存空间，这样才可以读取或者保存数据。</p>
<h4 id="X2：寄存器"><a href="#X2：寄存器" class="headerlink" title="X2：寄存器"></a>X2：寄存器</h4><p>寄存器的内容太多，不展开了，借用wiki的定义吧。</p>
<blockquote>
<p>寄存器（Register）是中央处理器内用来暂存指令、数据和地址的电脑存储器。寄存器的存贮容量有限，读写速度非常快。在计算机体系结构里，寄存器存储在已知时间点所作计算的中间结果，通过快速地访问数据来加速计算机程序的运行。</p>
</blockquote>
<h4 id="X3：其他资源"><a href="#X3：其他资源" class="headerlink" title="X3：其他资源"></a>X3：其他资源</h4><p>如linux下的标准输入、标准输出、错误等文件描述符也会被申请创建。</p>
<h4 id="进程是如何被创建的"><a href="#进程是如何被创建的" class="headerlink" title="进程是如何被创建的"></a>进程是如何被创建的</h4><p>当拥有了程序、内存、寄存器等资源后，操作系统就可以开始着手创建一个进程了，创建过程中具体做了些什么呢？</p>
<ol>
<li>将程序加载到内存中<blockquote>
<p>在早期的操作中，加载会在运行程序前全部完成，现在则是采用惰性加载，只有运行运行过程中发现需要使用，才会进行加载。至于惰性加载是如何实现的，后续会继续尝试分析（大概吧）。</p>
</blockquote>
</li>
<li>为进程申请一些运行中需要使用的内存空间</li>
<li>其他的初始化任务</li>
</ol>
<p>当操作系统的把一切前置工作都准备好了之后，进程创建完成，操作系统将CPU控制权转交给进程，开始运行。</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><ol>
<li>当程序拥有了硬件资源（内存、寄存器等）并开始运行后，就成了进程</li>
<li>进程是操作系统中的一个概念，因此脱离了操作系统后，进程也就不存在了</li>
</ol>
<p>至此，我们已经成功创建了一个进程，但是实际上使用中，我们拥有大量的进程，操作系统该如何管理这些进程呢？这个问题十分复杂（至少对于我来说是这样的）。后面的内容会尝试讨论操作系统的调度（进程）的策略。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://xudalin0609.github.io/2017/01/01/%E5%85%B3%E4%BA%8Emysql%E7%9A%84%E9%94%81/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Xu">
      <meta itemprop="description" content="独自发疯">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Relax And Slower">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2017/01/01/%E5%85%B3%E4%BA%8Emysql%E7%9A%84%E9%94%81/" class="post-title-link" itemprop="url">关于mysql的锁</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2017-01-01 00:00:00" itemprop="dateCreated datePublished" datetime="2017-01-01T00:00:00+08:00">2017-01-01</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-11-06 23:09:15" itemprop="dateModified" datetime="2023-11-06T23:09:15+08:00">2023-11-06</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E9%97%AE%E9%A2%98%E5%AE%9A%E4%BD%8D/" itemprop="url" rel="index"><span itemprop="name">问题定位</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>测试原因：在 mysql 中更新字段类型的时候，发生了 metadata lock，但是<code>show processlist</code>没有发现其他的持有锁的任务正在执行。最后，在阿里云的后台杀掉了一个无效连接，释放了该锁。</p>
<p>猜测：由于使用 sqlalchemy 的 session 过程中，任务异常停止，导致 sqlalchemy 没有释放连接导致该情况的产生。</p>
<ol>
<li>测试 1<br>创建一个 session,并挂起任务，同时修改数据库结构</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> cases.extensions <span class="keyword">import</span> Session</span><br><span class="line"></span><br><span class="line">session = Session()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">test_case</span>():</span><br><span class="line">    time.sleep(<span class="number">100</span>)</span><br><span class="line">    session.close()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    test_case()</span><br></pre></td></tr></table></figure>

<p>测试结果，在 session 期间可以正常修改表结构，没有产生 metadata lock，创建 session 并没有产生一个持有 metalock 的连接。</p>
<ol start="2">
<li>测试 2</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">session = Session()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">test_case</span>():</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        stmt = test_ent.update().where(test_ent.columns.<span class="built_in">id</span>==<span class="number">1</span>).values(c_a=<span class="string">&quot;test1&quot;</span>)</span><br><span class="line">        time.sleep(<span class="number">100</span>)</span><br><span class="line">        session.close()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>测试结果，在 session 期间可以正常修改表结构，没有产生 metadata lock，创建 session 并没有产生一个持有 metalock 的连接。</p>
<ol start="3">
<li>测试 3</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">test_case3</span>():</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>):</span><br><span class="line">        stmt = test_ent.update().where(test_ent.columns.<span class="built_in">id</span>==<span class="number">1</span>).values(c_a=<span class="built_in">str</span>(i))</span><br><span class="line">        session.execute(stmt)</span><br><span class="line">        time.sleep(<span class="number">100</span>)</span><br><span class="line">    session.commit()</span><br></pre></td></tr></table></figure>
<p>测试结果，产生了一个metalock阻止了期间进行的表结构修改（ddl类型操作）。</p>
<ol start="4">
<li>测试 4</li>
</ol>
<p>那么如果是dml类型的操作会产生metalock么？</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">test_case4</span>():</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>):</span><br><span class="line">        stmt = test_ent.select().where(test_ent.columns.<span class="built_in">id</span>==<span class="number">1</span>)</span><br><span class="line">        session.execute(stmt)</span><br><span class="line">        time.sleep(<span class="number">20</span>)</span><br><span class="line">    session.commit()</span><br></pre></td></tr></table></figure>
<p>测试结果，仍然产生了一个metalock。</p>
<p>matalock是什么？又为了解决什么问题呢？</p>
<ul>
<li><p>MDL出现的初衷就是为了保护一个处于事务中的表的结构不被修改。</p>
</li>
<li><p>这里提到的事务包括两类，显式事务和AC-NL-RO（auto-commit non-locking read-only）事务。显式事务包括两类：1. 关闭AutoCommit下的操作，2. 以begin或start transaction开始的操作。AC-NL-RO可理解为AutoCommit开启下的select操作。</p>
</li>
<li><p>MDL是事务级别的，只有在事务结束后才会释放。在此之前，其实也有类似的保护机制，只不过是语句级别的。</p>
</li>
</ul>
<p>到具体问题上主要是两类，不可重复读和主从复制问题。<br>不可重复读的例子如下，当第一次产生ddl操作但是没有执行commit，然后依次执行select、commit、select就会发现两次读取的结果不一样。（这也是上面case4中metalock产生的原因）</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">session1<span class="operator">&gt;</span> <span class="keyword">begin</span>;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line">session1<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t1;</span><br><span class="line"><span class="operator">+</span><span class="comment">------+------+</span></span><br><span class="line"><span class="operator">|</span> id  <span class="operator">|</span> name <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+------+</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">1</span> <span class="operator">|</span> a    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">2</span> <span class="operator">|</span> b    <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+------+</span></span><br><span class="line"><span class="number">2</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line">session2<span class="operator">&gt;</span> <span class="keyword">alter</span> <span class="keyword">table</span> t1 <span class="keyword">add</span> c1 <span class="type">int</span>;</span><br><span class="line">Query OK, <span class="number">2</span> <span class="keyword">rows</span> affected (<span class="number">0.02</span> sec)</span><br><span class="line">Records: <span class="number">2</span>  Duplicates: <span class="number">0</span>  Warnings: <span class="number">0</span></span><br><span class="line">session1<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t1;</span><br><span class="line"><span class="keyword">Empty</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line">session1<span class="operator">&gt;</span> <span class="keyword">commit</span>;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line">session1<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t1;</span><br><span class="line"><span class="operator">+</span><span class="comment">------+------+------+</span></span><br><span class="line"><span class="operator">|</span> id  <span class="operator">|</span> name <span class="operator">|</span> c1  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+------+------+</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">1</span> <span class="operator">|</span> a    <span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">2</span> <span class="operator">|</span> b    <span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+------+------+</span></span><br><span class="line"><span class="number">2</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<p>接下来看主从复制的情况</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">session1<span class="operator">&gt;</span> <span class="keyword">create</span> <span class="keyword">table</span> t1(id <span class="type">int</span>,name <span class="type">varchar</span>(<span class="number">10</span>)) engine<span class="operator">=</span>innodb;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line">session1<span class="operator">&gt;</span> <span class="keyword">begin</span>;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line">session1<span class="operator">&gt;</span> <span class="keyword">insert</span> <span class="keyword">into</span> t1 <span class="keyword">values</span>(<span class="number">1</span>,<span class="string">&#x27;a&#x27;</span>);</span><br><span class="line">Query OK, <span class="number">1</span> <span class="type">row</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line">session2<span class="operator">&gt;</span> <span class="keyword">truncate</span> <span class="keyword">table</span> t1;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.46</span> sec)</span><br><span class="line">session1<span class="operator">&gt;</span> <span class="keyword">commit</span>;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.35</span> sec)</span><br><span class="line">session1<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t1;</span><br><span class="line"><span class="keyword">Empty</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>
<p>此时从库的结果为</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">session1&gt; select * from t1;</span><br><span class="line">+------+------+------+</span><br><span class="line">| id   | name | c1   |</span><br><span class="line">+------+------+------+</span><br><span class="line">|    1 | a    | NULL |</span><br><span class="line">+------+------+------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<p>查看binlog,可以看到truncat操作在前，insert操作在后</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"># at 7140</span><br><span class="line">#180714 19:32:14 server id 1  end_log_pos 7261    Query    thread_id=31    exec_time=0    error_code=0</span><br><span class="line">SET TIMESTAMP=1531567934/*!*/;</span><br><span class="line">create table t1(id int,name varchar(10)) engine=innodb</span><br><span class="line">/*!*/;</span><br><span class="line"># at 7261</span><br><span class="line">#180714 19:32:30 server id 1  end_log_pos 7333    Query    thread_id=32    exec_time=0    error_code=0</span><br><span class="line">SET TIMESTAMP=1531567950/*!*/;</span><br><span class="line">BEGIN</span><br><span class="line">/*!*/;</span><br><span class="line"># at 7333</span><br><span class="line">#180714 19:32:30 server id 1  end_log_pos 7417    Query    thread_id=32    exec_time=0    error_code=0</span><br><span class="line">SET TIMESTAMP=1531567950/*!*/;</span><br><span class="line">truncate table t1</span><br><span class="line">/*!*/;</span><br><span class="line"># at 7417</span><br><span class="line">#180714 19:32:30 server id 1  end_log_pos 7444    Xid = 422</span><br><span class="line">COMMIT/*!*/;</span><br><span class="line"># at 7444</span><br><span class="line">#180714 19:32:34 server id 1  end_log_pos 7516    Query    thread_id=31    exec_time=0    error_code=0</span><br><span class="line">SET TIMESTAMP=1531567954/*!*/;</span><br><span class="line">BEGIN</span><br><span class="line">/*!*/;</span><br><span class="line"># at 7516</span><br><span class="line">#180714 19:32:24 server id 1  end_log_pos 7611    Query    thread_id=31    exec_time=0    error_code=0</span><br><span class="line">SET TIMESTAMP=1531567944/*!*/;</span><br><span class="line">insert into t1 values(1,&#x27;a&#x27;)</span><br><span class="line">/*!*/;</span><br><span class="line"># at 7611</span><br><span class="line">#180714 19:32:34 server id 1  end_log_pos 7638    Xid = 421</span><br><span class="line">COMMIT/*!*/;</span><br></pre></td></tr></table></figure>

<p>至此便不难理解在这次问题中出现的情况了，由于后台有一个事务一直没有进行commit、rollback等操作，使得metalock一直存在，以至于不能进行ddl操作</p>
<p>参考文章</p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/chenpingzhao/p/9642732.html">https://www.cnblogs.com/chenpingzhao/p/9642732.html</a></p>
<p><a target="_blank" rel="noopener" href="https://yq.aliyun.com/articles/638450">https://yq.aliyun.com/articles/638450</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Xu</p>
  <div class="site-description" itemprop="description">独自发疯</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">8</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
        <span class="site-state-item-count">5</span>
        <span class="site-state-item-name">分类</span>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">7</span>
        <span class="site-state-item-name">标签</span>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Xu</span>
</div>
  <div class="powered-by">
    <!--由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动 -->
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
